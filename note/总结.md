# BridgeLang – Multimodal Task Supplementor（可见事实抽取）

## 1) 执行摘要

* **目标**：从图像+任务描述中抽取**可见且可检验**的结构化事实（`FACT_LIST`：objects/location/pose/grasp\_points/…）与短句 `SUPPLEMENT`，用于机器人感知→操作规划链路，并以**coverage / confirmed**与**disagreement**建立可复现评测；之后把“72B 复核信号/知识”蒸馏给轻量 3B，落地到 OpenVLA。
* **成功标准**：

  * `coverage`（含 "UNCERTAIN"）四键≥**100%**（已达）；
  * `confirmed_pose ≥ 50%`、`confirmed_grasp_points ≥ 50%`（val50 上已接近/部分达成）；
  * `disagreement ≤ 40%`（pose/grasp 聚焦 prompt 在 val50 已降到 40–42%，val200 尚在 57.5%，需继续优化与蒸馏）。
* **里程碑**：

  * M1 基线引擎与协议落地；M2 pose/grasp 聚焦提示词；M3 审核/一致性与分歧分析；M4 72B→3B 蒸馏；M5 集成到 OpenVLA 做端到端 A/B。
* **当前进度**：
  ✅ 已完成 协议&引擎&清洗&双指标评测、val50/val200 跑通、分歧与不确定性三角化导出；
  🛠 进行中 pose/grasp 提示词收敛、72B 复核驱动的半自动修正&蒸馏集构建；
  📝 待办 大规模跑数、OpenVLA 集成与 A/B、终稿撰写。
* **主要问题**：pose 仍高不确定（val200 `confirmed_pose=39%`）；对象可见占比随场景波动（62–80%）；val200 分歧 57.5% 较高——需要“少量 few-shot + 72B 复核纠偏 + 蒸馏”。

---

## 2) 背景 & 约束

* **背景/场景**：恢复机器人任务所需的**可见事实**，避免幻觉；以结构化输出支撑抓取点/避障/位姿等决策，且可被第二模型和人工可靠复核。
* **约束**：

  * **可见性第一**：不可见即 `UNCERTAIN` + 原因放入 `uncertain`；不得把任务文本当作事实。
  * **轻量推理**：3B 需可离线、可量化；72B 用作复核/教师。
  * **一致格式**：严格两块输出与 schema 校验；json 合法性强约束。
* **依赖项目**：Qwen2.5-VL 系列、LLaVA-1.6-34B（抽检）、OpenVLA（下游操控基线）。

---

下面给出**可直接粘贴替换**的两节内容（第 3 节与第 4 节），已按我们讨论的“端到端优先 + 补充器为辅”的标准重写并细化了 M4/M5 的 E2E 验收标准。

---

## 3) 目标 & 成功标准（OKR）——修订版

### 3.1 北极星（端到端 OpenVLA）

**Primary（E2E）**

* **OpenVLA Task Success Rate（TSR）**：在 `val_50 / val_200`（外加 1–2 个仿真/小规模实机基准）上

  * **OpenVLA + Supplementor（未蒸馏）** ≥ Baseline **+5–8 个百分点**
  * **OpenVLA + Supplementor（经 72B 蒸馏）** ≥ Baseline **+8–12 个百分点**
* **Action Top-1 准确率/轨迹可执行率**：≥ Baseline **+5pp**
* **失败类型下降**：与抓取/位姿相关失败（抓偏、滑落、碰撞）**相对下降 ≥20%**

**Secondary（E2E）**

* **碰撞率** ≤ **5%**
* **端到端时延**：相对 Baseline **增长 ≤15%**

**验收方式（E2E）**

* 同一 manifest（`val_50.csv`, `val_200.csv`）+ 至少 1 个仿真/小规模实机集，做三臂对照：

  1. **OpenVLA Baseline**
  2. **OpenVLA + 3B 补充器（未蒸馏）**
  3. **OpenVLA + 3B 补充器（经 72B 复核蒸馏）**
* 每臂 **≥3 次独立重复**；对 TSR/Top-1 做比例差的 **Wilson 置信区间**与 **McNemar**（成对）检验，显著性阈值 **p < 0.05**

---

### 3.2 补充器子目标（服务 E2E）

**Primary（补充器）**

* **confirmed\_pose ≥ 50%**（先在 `val_50` 达标，再推 `val_200`）
* **confirmed\_grasp\_points ≥ 50%**
* **disagreement ≤ 40%**（`val_50` 已 \~40–42%，`val_200` 继续优化/蒸馏）

**Secondary（补充器）**

* **coverage 四键 = 100%**（objects / location / pose / grasp\_points，含 "UNCERTAIN" 计入覆盖）
* **avg\_elapsed\_s ≈ 25–30s**

**验收方式（补充器）**

* 同一 manifest 上 **基线 vs pose/grasp 聚焦 vs 蒸馏版** 的 A/B；
* 与 E2E 一致的统计方法（Wilson CI / McNemar），验证子指标提升与 E2E 提升具有关联性

---

### 3.3 为什么保留这些“子指标”

* 作为**可快迭代**的前置信号（leading indicators），不用每次都跑完整条控制链也能判断补充器是否**减少幻觉、提高可见性**
* `confirmed_pose / confirmed_grasp` 与 E2E 的抓取相关失败强相关
* `disagreement` 下降 → **表述更一致**，下游决策噪声更低

---

### 3.4 E2E 集成与评测矩阵

* **集成 A（无训练）**：把 `[FACT_LIST]`（或其紧凑 JSON）作为 **side-channel** 拼接到 OpenVLA 文本输入，验证“信息增益”
* **集成 B（蒸馏/微调）**：用 **Qwen2.5-VL-72B** 复核/打分的高置信补充，结合真实动作结果，对 **OpenVLA** 做**轻量蒸馏/微调**
* **评测矩阵**：三臂（Baseline / +未蒸馏 / +蒸馏） × 两套基准（`val_50` / `val_200` + 仿真/小实机） × 多指标（TSR / Top-1 / 失败分解 / 时延）

---

## 4) 总体计划 & 里程碑（含 M4/M5 E2E 验收细化）

| ID     | 阶段/里程碑                         | 时间范围      | 关键交付物                                             | 状态  |
| ------ | ------------------------------ | --------- | ------------------------------------------------- | --- |
| M1     | 补充器基线与可见性规范（pose/grasp 聚焦）     | <起–止>     | 规范化提示词、清洗/统计脚本、`val_50/val_200` 指标基线              | ☐/☑ |
| M2     | 多模型构建与互校（3B/72B/LLaVA-34B）     | <起–止>     | Qwen-2.5-VL-3B/72B 推理&复核流水线、LLaVA-1.6-34B 抽检可信度报告 | ☐/☑ |
| M3     | 高置信数据与蒸馏准备                     | <起–止>     | 72B 复核打分 + triage 列表、蒸馏样本集（含不确定标注与对齐）             | ☐/☑ |
| **M4** | **E2E 集成 A（未蒸馏 side-channel）** | **<起–止>** | **OpenVLA + Supplementor（未蒸馏）端到端评测报告**            | ☐/☑ |
| **M5** | **E2E 集成 B（蒸馏/微调）**            | **<起–止>** | **OpenVLA + Supplementor（蒸馏）端到端评测报告 & ablation**  | ☐/☑ |

### M4 验收标准（E2E-未蒸馏）

**配置**

* 三臂：Baseline / +3B 补充器（未蒸馏） / +72B 复核提示但**不**改 OpenVLA 权重
* 数据：`val_50.csv`, `val_200.csv` + 至少 1 个仿真/小实机子集
* 运行：每臂 **≥3 次独立重复**，固定随机种子/硬件记录

**指标（达标即通过）**

* **TSR**：+3B 未蒸馏臂相对 Baseline **≥ +5pp**（两套数据中至少达标其一，另一套≥+3pp）
* **Top-1 / 可执行率**：**≥ +5pp**（任一集达标，另一集不劣化超过 2pp）
* **抓取相关失败**：相对下降 **≥20%**（以人工/规则分类统计）
* **时延**：端到端相对增长 **≤15%**

**统计检验**

* TSR/Top-1 的比例差 **Wilson 95% CI** 不跨 0；**McNemar**（配对）**p < 0.05**

**交付物**

* 报告：总表 + 分解（按任务类型/物类/场景）+ 显著性统计
* 复现实验脚本与日志：命令行、版本、硬件、时间消耗
* 侧信道消融：**仅 FACT\_LIST** / **仅 SUPPLEMENT** / **二者皆用**

---

### M5 验收标准（E2E-蒸馏/微调）

**配置**

* 三臂：Baseline / +3B 未蒸馏 / **+3B（经 72B 复核蒸馏）**
* 蒸馏集：来自 `val_50/val_200` 同分布样本 + 额外少量同域扩展；包含 72B 复核分数与不确定标注
* 训练：轻量蒸馏/微调（不改变 OpenVLA 主干架构），记录学习率/步数/早停准则

**指标（达标即通过）**

* **TSR**：蒸馏臂相对 Baseline **≥ +8–12pp**；相对未蒸馏臂 **≥ +3pp**
* **Top-1 / 可执行率**：相对 Baseline **≥ +5pp**
* **抓取相关失败**：相对 Baseline **≥ 25% 下降**
* **时延**：相对 Baseline **≤15%** 增幅；与未蒸馏臂相差 **≤5%**

**统计检验**

* 与 M4 同（Wilson CI / McNemar，p < 0.05），并报告训练方差（≥3 次独立训练）

**交付物**

* 报告：主指标与分解、学习曲线、过拟合检查（train/val gap）、蒸馏样本可视化
* Ablation：

  * 去除 `uncertain` 条目对结果的影响
  * 仅用 `pose` / 仅用 `grasp_points` / 全量对照
  * 72B 复核阈值不同（如 0.6/0.7/0.8）对效果的影响
* 复现材料：训练/评测脚本、配置、模型快照

---

> 注：以上里程碑与验收标准与我们现有资产保持一致：
>
> * **模型侧**：Qwen2.5-VL-3B（补充器生成）、Qwen2.5-VL-72B（复核/蒸馏教师）、LLaVA-1.6-34B（抽检可信度）
> * **数据与评测**：`val_50.csv`, `val_200.csv`，`val_all.csv`，以及已落地的清洗/统计/对照脚本
> * **后续对照**：OpenVLA、OpenVLA + 3B（未蒸馏）、OpenVLA + 3B（蒸馏）

---

## 5) 当前状态

**已完成（Done）**

| 任务                                               | 证据/产物路径                                                                          |
| ------------------------------------------------ | -------------------------------------------------------------------------------- |
| Qwen2.5-VL-3B 引擎（离线、FA2、坏词过滤、后处理/截断）             | `supplementor/engine/qwen_vl.py`                                                 |
| Qwen2.5-VL-72B 作为 verify/alt\_verify             | 运行日志多处；命令行参数 `--verify_model_id / --alt_verify_model_id`                         |
| LLaVA-1.6-34B 抽检                                 | 多次抽检日志（提升数据可信度）                                                                  |
| 统一评测脚本（coverage/confirmed/disagreement + 表格/TeX） | `scripts/jsonl_to_table_v2.py`                                                   |
| 一致性修正/不确定性分流清单（triage）                           | `scripts/enforce_uncertain_consistency.py`, `scripts/export_uncertain_triage.py` |
| 提示词协议升级（可见性第一；grasp 决策规则；few-shot 正/负例）          | `prompts/supplementor_en.txt`                                                    |
| 基线与多版本对比（val50/val200）                           | `logs/bridge_v2_val50*.jsonl`, `logs/bridge_v2_val200*.jsonl`                    |

**进行中（Doing）**

| 任务                   | 预计完成目标                                                   |
| -------------------- | -------------------------------------------------------- |
| pose/grasp 平衡提示词微调收敛 | `confirmed_pose/grasp ≥ 50%`；`disagreement ≤ 40%`（val50） |
| 72B 复核驱动的样例校正/教师信号提取 | 构建高置信蒸馏集（pose/grasp）                                     |

**待办（Todo，含优先级）**

| 任务                      | 依赖         |
| ----------------------- | ---------- |
| 72B→3B 蒸馏（轻量高效训练脚本）     | 蒸馏集、训练资源   |
| OpenVLA 集成（未蒸馏/蒸馏）端到端对照 | 蒸馏完成、接口适配  |
| 大规模全量跑数与最终表格/曲线/显著性检验   | 提示词收敛、算力窗口 |
| 论文撰写（方法/系统/实验/消融/定性）    | 全部实证结果与图表  |

---

## 6) 文件清单（功能说明）

| 编号   | 路径                                                       | 作用&核心逻辑                                                | 关键类/函数                                  | 输入→输出                                       | 依赖/副作用         | 入口/CLI                                                                                                      | Owner |
| ---- | -------------------------------------------------------- | ------------------------------------------------------ | --------------------------------------- | ------------------------------------------- | -------------- | ----------------------------------------------------------------------------------------------------------- | ----- |
| F-01 | `supplementor/engine/qwen_vl.py`                         | Qwen2.5-VL 本地推理引擎（离线、FA2、坏词过滤、区块解析与清洗）                 | `QwenVLSupplementor.infer/_postprocess` | (images, task) → `[FACT_LIST]…[SUPPLEMENT]` | 读模型权重/GPU 显存   | 作为 `batch_eval_inproc.py` 依赖                                                                                | 你     |
| F-02 | `prompts/supplementor_en.txt`                            | 协议化提示词：可见事实、UNCERTAIN、grasp 决策、few-shot                | -                                       | - → 稳定结构化输出                                 | -              | 由引擎作为 system prompt 加载                                                                                      | 你     |
| F-03 | `scripts/batch_eval_inproc.py`                           | 批量评测：draft/verify/alt\_verify、日志 JSONL 输出              | `main()`                                | manifest → `*.jsonl`                        | 读写 logs/；调用多模型 | `python scripts/batch_eval_inproc.py --manifest … --model_id … --verify_model_id … --alt_verify_model_id …` | 你     |
| F-04 | `scripts/jsonl_to_table_v2.py`                           | 汇总与双指标（coverage/confirmed）统计、CSV/TeX 输出                | `get_fact()` 等                          | `*.jsonl` → `*.csv`/`*.tex`                 | -              | `python scripts/jsonl_to_table_v2.py --in_jsonl … --out_csv …`                                              | 你     |
| F-05 | `scripts/enforce_uncertain_consistency.py`               | 将 `uncertain` 信号与字段取值对齐（如含“pose:…”则置 `pose=UNCERTAIN`） | `main()`                                | `*.jsonl` → 修正后 `*.jsonl`                   | 写文件            | `python scripts/enforce_uncertain_consistency.py --in_jsonl … --out_jsonl …`                                | 你     |
| F-06 | `scripts/export_uncertain_triage.py`                     | 导出不确定样本清单（便于人工复核或 72B 教师再审）                            | `main()`                                | `*.jsonl` → `*.csv`                         | 写文件            | `python scripts/export_uncertain_triage.py --in_jsonl … --out_csv …`                                        | 你     |
| F-07 | `scripts/jsonl_to_table.py`（老版）                          | 早期统计脚本（已被 v2 覆盖，仍可参考）                                  | -                                       | `*.jsonl` → `*.csv/tex`                     | -              | `python scripts/jsonl_to_table.py …`                                                                        | 你     |
| F-08 | `data/bridgedata_v2/manifests/val_50.csv`, `val_200.csv` | 评测清单（图像/任务列表）                                          | -                                       | - → 批处理输入                                   | -              | 上述 batch\_eval 作为输入                                                                                         | 你     |

---

## 7) 目录结构

（关键目录）

```
/mnt/BridgeLang/
├─ supplementor/
│  ├─ engine/qwen_vl.py
│  └─ prompts/supplementor_en.txt
├─ scripts/
│  ├─ batch_eval_inproc.py
│  ├─ jsonl_to_table_v2.py
│  ├─ enforce_uncertain_consistency.py
│  ├─ export_uncertain_triage.py
│  └─ jsonl_to_table.py (legacy)
├─ data/bridgedata_v2/manifests/
│  ├─ val_50.csv
│  └─ val_200.csv
└─ logs/
   ├─ bridge_v2_val50.*.jsonl / *.csv / *.tex
   └─ bridge_v2_val200.*.jsonl / *.csv
```

## 8) 环境情况

* Conda 环境：`openvla`（PyTorch + Transformers；FA2 可用）
* 运行警告：部分 `temperature` flag 被 HF 忽略（已在引擎内做 do\_sample 条件传参）；`Qwen2VLImageProcessor` fast 模式提示；一体化 Flash-Attn v2 配置。
* 模型：`/mnt/BridgeLang/Qwen2.5-VL-3B-Instruct`、`/mnt/BridgeLang/Qwen2.5-VL-72B-Instruct`、`/mnt/BridgeLang/LLaVA-v1.6-34B`（均离线加载）。

---

## 9) 评测脚本

* 批跑：

  ```
  python scripts/batch_eval_inproc.py \
    --manifest /mnt/BridgeLang/data/bridgedata_v2/manifests/val_50.csv \
    --out_jsonl /mnt/BridgeLang/logs/bridge_v2_val50.<tag>.jsonl \
    --with_verify --with_alt_verify \
    --model_id /mnt/BridgeLang/Qwen2.5-VL-3B-Instruct \
    --verify_model_id /mnt/BridgeLang/Qwen2.5-VL-72B-Instruct \
    --alt_verify_model_id /mnt/BridgeLang/LLaVA-v1.6-34B \
    --offline
  ```
* 汇总：

  ```
  python scripts/jsonl_to_table_v2.py \
    --in_jsonl  /mnt/BridgeLang/logs/bridge_v2_val50.<tag>.jsonl \
    --out_csv   /mnt/BridgeLang/logs/bridge_v2_val50.<tag>.table.csv
  ```

---

## 10) 当前工作记录

* **基线（after\_fix，val50）**：
  `coverage`：四键 100%；`confirmed_pose≈46%`、`confirmed_grasp_points≈56%`；`disagreement≈60%`。
* **pose 聚焦（posev1，val50）**：
  `confirmed_pose` **46% → 48%**；`disagreement` **60% → 40%**（显著降低）。
* **pose 聚焦（posev2，val50）**：
  退化（`confirmed_pose≈40%`、`disagreement≈54%`），已回滚到 v1 思路。
* **可见性仅约束（visible\_only.fix，val50）**：
  `confirmed_location≈92%`、`confirmed_pose≈46%`、`confirmed_grasp≈42%`、`disagreement≈40%`。
* **grasp 聚焦（graspv1 / v2lite，val50）**：
  `confirmed_grasp_points` 提升至 **≈50%**（v1 更优；v2lite 稍回落）；`disagreement≈42–44%`。
* **大集（after\_fix，val200）**：
  `coverage` 四键 100%；`confirmed_pose=39%`、`confirmed_grasp=55%`、`disagreement=57.5%`；
  `UNCERTAIN` 分布以 pose 为主（180/200），提示“位姿可见性/词表覆盖不足”。

---

## 11) 注意事项 & 补充

* **协议优先**：objects 只写**可见**目标；不可见不填、原因进 `uncertain`。location/pose/grasp 不可见 → 值置 `"UNCERTAIN"`（或 `["UNCERTAIN"]`），并在 `uncertain` 记因。
* **一致性**：若 `uncertain` 含 `pose:*` 则强制 `pose="UNCERTAIN"`；`grasp_points` 若含 `"UNCERTAIN"` 必须**单元素**且不可与具体点混用。
* **提示词版本管理**：保持 `GRASP DECISION (balanced)` 为当前稳定版；pose few-shot 以正例为主、负例极简；避免模板化句式。
* **72B 复核与蒸馏**：

  * 先用 72B/LLaVA 打分与纠偏（生成 triage），构建**高置信子集**；
  * 将 `pose/grasp` 的“可见性-判别”知识蒸馏到 3B；
  * 以 val50/val200 的三指标对比验收蒸馏收益。
* **OpenVLA 集成计划**：

  1. Baseline：OpenVLA 原生；
  2. +3B（未蒸馏）结构化补充作为侧信道特征；
  3. +3B（蒸馏）替换/增强（期望对抓取成功率与路径合理性有正增益）。

---

> 提醒已纳入：
>
> * Qwen2.5-VL-3B/72B 的构建与使用；
> * LLaVA-1.6-34B 用于抽检确定数据可信度；
> * 72B 复核和蒸馏计划；
> * 后续对照实验：OpenVLA、OpenVLA+3B（未蒸馏）、OpenVLA+3B（蒸馏）。

如需，我可以把当前 **val50/val200 的关键表格**与**不确定性 triage**做一个小型对照看板（CSV/TeX 导出路径已在上表给出），便于写作与汇报。
